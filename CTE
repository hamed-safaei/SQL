

;WITH CTE AS (
SELECT orderid , productid , unitprice , qty , 
CASE WHEN discount < 0.05 THEN discount + 0.01
ELSE discount END  AS NewDiscount ---IIF(discount < 0.05 , discount + 0.01 , discount )
FROM Sales.OrderDetails
), CTE2 AS (
SELECT * , qty * unitprice * ( 1 - NewDiscount ) AS totalSales
FROM CTE
)
SELECT * FROM CTE2


----------------------------------------------------


;WITH BF AS (
SELECT 
od.orderid , o.custid , SUM(qty * unitprice) AmountBefore
FROM Sales.OrderDetails od
INNER JOIN Sales.Orders o On o.orderid = od.orderid
GROUP BY o.custid , od.orderid
),Delays AS (
SELECT orderid ,
DATEDIFF(DAY , requireddate , 
IIF(shippeddate IS NOT NULL , Shippeddate , DATEADD(DAY , 40 , requireddate) )
) AS CountDelay
FROM sales.Orders
WHERE DATEDIFF(DAY , requireddate , 
IIF(shippeddate IS NOT NULL , Shippeddate , DATEADD(DAY , 40 , requireddate) )
) > 0
) 
SELECT BF.* , ISNULL(D.CountDelay * 0.001 * AmountBefore , 0)Fine,
AmountBefore - ISNULL(D.CountDelay * 0.001 * AmountBefore , 0) AmountAfter
FROM BF 
LEFT JOIN Delays D ON D.orderid = BF.orderid




----With Temp Table

-- تمپ تیبل اول: BF
CREATE TABLE #BF (
    orderid INT,
    custid INT,
    AmountBefore MONEY
);

INSERT INTO #BF
SELECT 
    od.orderid, 
    o.custid, 
    SUM(qty * unitprice) AS AmountBefore
FROM Sales.OrderDetails od
INNER JOIN Sales.Orders o ON o.orderid = od.orderid
GROUP BY o.custid, od.orderid;

-- تمپ تیبل دوم: Delays
CREATE TABLE #Delays (
    orderid INT,
    CountDelay INT
);

INSERT INTO #Delays
SELECT 
    orderid,
    DATEDIFF(
        DAY, 
        requireddate, 
        IIF(shippeddate IS NOT NULL, shippeddate, DATEADD(DAY, 40, requireddate))
    ) AS CountDelay
FROM sales.Orders
WHERE DATEDIFF(
        DAY, 
        requireddate, 
        IIF(shippeddate IS NOT NULL, shippeddate, DATEADD(DAY, 40, requireddate))
    ) > 0;


SELECT 
    BF.*, 
    ISNULL(D.CountDelay * 0.001 * BF.AmountBefore, 0) AS Fine,
    BF.AmountBefore - ISNULL(D.CountDelay * 0.001 * BF.AmountBefore, 0) AS AmountAfter
FROM #BF BF
LEFT JOIN #Delays D ON D.orderid = BF.orderid;


DROP TABLE #BF;
DROP TABLE #Delays;



