WITH cte AS (
  SELECT 
    custid,
    SUM(qty * unitprice) AS amount
  FROM Sales.OrderDetails od
  INNER JOIN Sales.Orders o ON o.orderid = od.orderid
  GROUP BY custid
)
SELECT *,
  NTILE(10) OVER(ORDER BY amount DESC) AS rn1
FROM cte



--------------

;WITH CTE AS (
SELECT  od.productid , p.productname , SUM(od.qty*od.unitprice) AS AmountOfProduct ,
COUNT(od.orderid) AS [count]
FROM Sales.OrderDetails od
INNER JOIN Production.Products p ON p.productid = od.productid
GROUP BY od.productid , p.productname
),CTE2 AS(
SELECT * ,
NTILE(10)OVER(ORDER BY CTE.count DESC ) AS RnCount
FROM CTE
)
SELECT * ,
NTILE(10)OVER(ORDER BY CTE2.AmountOfProduct DESC) AS RnAmount
FROM CTE2

--------------------

;WITH CTE AS(
SELECT c.country ,c.city ,SUM(qty * unitprice)Amount
FROM Sales.Customers c
INNER JOIN Sales.Orders o ON o.custid = c.custid
INNER JOIN Sales.OrderDetails od ON od.orderid = o.orderid
GROUP BY c.country , c.city
),CTE2 AS(
SELECT * ,
NTILE(5)OVER(ORDER BY Amount DESC)RnCountry
FROM CTE
)
SELECT * ,
NTILE(5)OVER(PARTITION BY country ORDER BY Amount DESC)RnCity
FROM CTE2
ORDER BY country DESC

------------------------------------------
FROM Sales.orders
GROUP BY custid),P AS(
SELECT MIN(LastSales)MINB , MAX(LastSales)MAXB , (MAX(LastSales) - MIN(LastSales)) /6 p FROM CTE
)
SELECT * ,
CASE WHEN LastSales BETWEEN MINB AND MINB+P THEN 1
WHEN LastSales BETWEEN MINB+2*p AND MINB+3*p THEN 2
WHEN LastSales BETWEEN MINB+3*p AND MINB+4*p THEN 3
WHEN LastSales BETWEEN MINB+4*p AND MINB+5*p THEN 4
WHEN LastSales BETWEEN MINB+5*p AND MINB+6*p THEN 5
WHEN LastSales BETWEEN MINB+6*p AND MAXB THEN 6
END AS cluster
FROM CTE
CROSS JOIN p


