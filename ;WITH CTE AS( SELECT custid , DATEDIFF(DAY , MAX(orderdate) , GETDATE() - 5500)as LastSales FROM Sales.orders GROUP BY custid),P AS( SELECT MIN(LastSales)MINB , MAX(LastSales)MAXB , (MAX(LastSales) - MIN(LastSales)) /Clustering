;WITH CTE AS(
SELECT custid , DATEDIFF(DAY , MAX(orderdate) , GETDATE() - 5500)as LastSales
FROM Sales.orders
GROUP BY custid),P AS(
SELECT MIN(LastSales)MINB , MAX(LastSales)MAXB , (MAX(LastSales) - MIN(LastSales)) /6 p FROM CTE
)
SELECT * ,
CASE WHEN LastSales BETWEEN MINB AND MINB+P THEN 1
WHEN LastSales BETWEEN MINB+2*p AND MINB+3*p THEN 2
WHEN LastSales BETWEEN MINB+3*p AND MINB+4*p THEN 3
WHEN LastSales BETWEEN MINB+4*p AND MINB+5*p THEN 4
WHEN LastSales BETWEEN MINB+5*p AND MINB+6*p THEN 5
WHEN LastSales BETWEEN MINB+6*p AND MAXB THEN 6
END AS cluster
FROM CTE
CROSS JOIN p
---------
SELECT
    custid,
    DATEDIFF(DAY, MAX(orderdate), DATEADD(DAY, -5500, GETDATE())) AS LastSales,
    NTILE(6) OVER (ORDER BY DATEDIFF(DAY, MAX(orderdate), DATEADD(DAY, -5500, GETDATE()))) AS cluster
FROM Sales.Orders
GROUP BY custid
